name: Release Please

on:
  push:
    branches:
      - main

# Top-level permissions must be explicitly granted for GITHUB_TOKEN
# This ensures the workflow can create and manage pull requests
permissions:
  contents: write        # Required: Create releases and tags
  pull-requests: write   # Required: Create and manage release PRs
  id-token: write        # Required: GitHub API authentication

jobs:
  release-please:
    name: Create Release PR
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # Job-level permissions (inherits from top-level but can be more restrictive)
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd  # v5.0.1
        with:
          fetch-depth: 0  # Fetch all history for proper version calculation

      - name: Calculate date-based CalVer
        id: calver
        run: |
          # CalVer format: YYYY.MM.DD-beta.BUILD (SemVer-compliant)
          YEAR=$(date -u +%Y)
          MONTH=$(date -u +%-m)
          DAY=$(date -u +%-d)

          # Get current version from manifest
          CURRENT=$(jq -r '."."' .release-please-manifest.json)
          echo "Current version in manifest: $CURRENT"

          # Parse current version to extract BUILD number
          # Match format: YYYY.MM.DD-beta.BUILD
          if [[ "$CURRENT" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)-beta\.([0-9]+) ]]; then
            C_YEAR="${BASH_REMATCH[1]}"
            C_MONTH="${BASH_REMATCH[2]}"
            C_DAY="${BASH_REMATCH[3]}"
            C_BUILD="${BASH_REMATCH[4]}"

            echo "Parsed: Year=$C_YEAR, Month=$C_MONTH, Day=$C_DAY, Build=$C_BUILD"

            # Same date? Increment build. New date? Reset to 1.
            if [ "$C_YEAR" == "$YEAR" ] && [ "$C_MONTH" == "$MONTH" ] && [ "$C_DAY" == "$DAY" ]; then
              BUILD=$((C_BUILD + 1))
              echo "Same date detected - incrementing build to $BUILD"
            else
              BUILD=1
              echo "New date detected - resetting build to 1"
            fi
          else
            BUILD=1
            echo "No valid version found - starting at build 1"
          fi

          NEW_VERSION="${YEAR}.${MONTH}.${DAY}-beta.${BUILD}"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Calculated version: $NEW_VERSION"

          # Store for later use
          echo "$NEW_VERSION" > /tmp/calver_version.txt

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@5d869da34e18e7287c1daad50e0b8ea0f506ce69  # v1.11.0
        with:
          app-id: ${{ secrets.RELEASE_PLEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_PLEASE_APP_PRIVATE_KEY }}
        continue-on-error: true

      - name: Run Release Please
        id: release
        uses: googleapis/release-please-action@7987652d64b4581673a76e33ad5e98e3dd56832f  # v4.1.3
        with:
          token: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}

      - name: Update Release PR with correct CalVer
        if: steps.release.outputs.pr
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token || secrets.GITHUB_TOKEN }}
        run: |
          # Get the PR number
          PR_NUM="${{ steps.release.outputs.pr }}"
          NEW_VERSION=$(cat /tmp/calver_version.txt)

          echo "ðŸ“ Updating PR #$PR_NUM with correct CalVer: $NEW_VERSION"

          # Get the release PR branch
          BRANCH=$(gh pr view "$PR_NUM" --json headRefName -q .headRefName)
          echo "Branch: $BRANCH"

          # Checkout the release PR branch
          git fetch origin "$BRANCH"
          git checkout "$BRANCH"

          # Update the manifest with correct version
          jq --arg v "$NEW_VERSION" '."." = $v' .release-please-manifest.json > .tmp.json
          mv .tmp.json .release-please-manifest.json

          # Update CHANGELOG.md title if it exists
          if [ -f "CHANGELOG.md" ]; then
            # Extract the old version from Release Please output
            OLD_VERSION="${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }}.${{ steps.release.outputs.patch }}"

            # Replace version in CHANGELOG
            sed -i "s/## \[${OLD_VERSION}\]/## [${NEW_VERSION}]/g" CHANGELOG.md
            sed -i "s|/compare/.*\.\.\..*)|/compare/pqc-scanner-v${NEW_VERSION%%-*}...pqc-scanner-v${NEW_VERSION})|g" CHANGELOG.md
          fi

          # Update Cargo.toml version (remove -beta.X suffix for Cargo)
          BASE_VERSION="${NEW_VERSION%%-*}"
          sed -i "s/^version = .*/version = \"${BASE_VERSION}\"/" Cargo.toml

          # Update MCP package.json version
          if [ -f "mcp/package.json" ]; then
            jq --arg v "$BASE_VERSION" '.version = $v' mcp/package.json > mcp/package.json.tmp
            mv mcp/package.json.tmp mcp/package.json
          fi

          # Commit and push changes
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .release-please-manifest.json CHANGELOG.md Cargo.toml mcp/package.json
          git commit -m "chore: update version to $NEW_VERSION" || echo "No changes to commit"
          git push origin "$BRANCH"

          # Update PR title
          gh pr edit "$PR_NUM" --title "chore(main): release pqc-scanner $NEW_VERSION"

          echo "âœ… PR #$PR_NUM updated with correct CalVer version"

      - name: Display Release Please outputs
        if: steps.release.outputs.release_created
        run: |
          echo "Release created: ${{ steps.release.outputs.release_created }}"
          echo "Tag name: ${{ steps.release.outputs.tag_name }}"
          echo "Version: ${{ steps.release.outputs.version }}"
          echo "PR number: ${{ steps.release.outputs.pr }}"
